# 🌌 NovaScribe VN Architect

**NovaScribe VN Architect** 是一款专为视觉小说（Visual Novel）设计的先进叙事架构与可视化写作工具。它打破了传统线性写作的限制，通过"网格化剧情管理"与"AI 叙事副驾驶"，帮助创作者构建逻辑严密、分支丰富的复杂故事网络。

---

## 📌 当前版本：v0.5.4

### ✅ 已实现功能

#### 1. 多视图系统
- **自由画布**：不受限制的节点布局，支持拖拽、缩放、平移
- **结构树图**：层次化展示故事结构，清晰观察剧情深度
- **地图视图**：按场景/地点分组展示节点，支持整体拖拽
- **数据库视图**：表格化浏览所有节点，支持搜索和快速定位

#### 2. AI 剧情引擎 (v0.5.4 增强)
- **多模型支持**：
  - Gemini: 2.5 Flash、2.5 Pro
  - GPT-4: GPT-4o、GPT-4o Mini
  - GPT-5: GPT-5.2、GPT-5.2 Pro、GPT-5.2 Codex、GPT-5 Mini、GPT-5 Nano
- **默认模型**：GPT-5.2（复杂推理和广泛知识）
- **API 配置面板**：界面内配置 API Key 和模型选择
- **全局剧情生成**：一键生成完整的剧情节点网络
- **单节点 AI 生成**：每个节点内置「AI 生成」按钮，根据相邻节点和剧情梗概智能生成内容
- **智能叙事分析** (v0.4 新增)：
  - 自动识别节点叙事功能（起点开场、延续剧情、分支点、汇聚点、结局收束）
  - 根据叙事功能调整内容风格和结构
  - 50-150字精简内容，避免冗长描述
- **自定义提示词** (v0.4 新增)：
  - 右侧属性面板可添加自定义提示词
  - 支持具体指令如"添加悬疑转折"、"让角色更情绪化"等
  - 优先满足用户自定义要求
- **智能上下文感知**：自动分析前置/后置节点，生成连贯的剧情内容
- 支持参数化生成：分支点数量 (1-10)、选项密度 (1-2)、故事深度 (3-5)
- 自动生成变量系统、前置条件和效果
- **错误边界保护** (v0.4 新增)：防止应用崩溃，友好显示错误信息
- **设置持久化** (v0.5 新增)：自动保存 AI 模型、API Key、提示词等设置到本地

#### 3. 节点系统 (v0.3 重构)
- **统一 Scene 节点**：所有节点都是 scene 类型，简化系统架构
- **动态分类标识**：
  - 🔵 **标准剧情** - 既有入边又有出边
  - 🟣 **自由剧情** - 无入边无出边（孤立场景）
  - 🟢 **起点** - 只有出边，无入边
  - 🔴 **终点** - 只有入边，无出边
  - 🟠 **分支剧情** - 选项后的专属剧情线（v0.3 新增）
- 使用不同颜色和图标直观区分节点类型

#### 4. Scene 节点属性扩展
- **包含选项**：
  - 布尔开关，标记节点是否包含玩家选择
  - 替代原有基于节点类型的判断逻辑
- **分支剧情**：
  - 标记节点为某个选项后的专属分支剧情
  - 可设置对应的选项索引（0-N）
  - 用于构建复杂的分支叙事结构
- **分组框架**：
  - 作为 scene 的 inspector 属性
  - 预留接口，用于后续剧情池/剧情块的分组规划

#### 5. 连线交互优化
- **自由连线系统**：
  - 输入端口（左侧蓝色三角形）- 接收连线
  - 输出端口（右侧绿色三角形）- 发出连线
  - 任何端口都可以拖拽连线到其他任何节点
  - 移除繁琐的"添加分支"操作，直接拖拽即可
- **连线编辑**：
  - 源端三角形可拖拽重连
  - 目标端三角形可拖拽重连
  - 选中连线后显示删除按钮
- **视觉反馈**：
  - 连线悬停高亮显示
  - 端口带阴影和悬停放大效果

#### 6. 变量系统
- 支持三种类型：number (数值)、boolean (布尔)、string (字符串)
- 核心叙事变量示例：支持自定义0-5个变量
- 用于前置条件判断和后置效果触发

#### 7. 实时模拟器
- 编辑器内直接运行故事
- 实时追踪变量变化
- 执行日志记录玩家选择路径

#### 8. 快照与历史管理
- 自动保存故事状态（最多 50 个版本）
- 手动创建带标签的快照
- 支持版本对比和恢复

#### 9. 导入与导出 (v0.5 新增)
- **导出故事**：
  - 一键导出完整故事结构为 JSON 文件
  - 包含所有节点、连线、变量、设置
  - 文件名自动带上日期
  - 兼容旧版本导入格式
- **导入故事**：
  - 支持导入之前导出的 JSON 文件
  - 导入前显示文件信息确认（版本、节点数、连线数）
  - 自动恢复相关设置（AI 模型、提示词等）
  - 自动兼容旧版本的边格式（from/to → source/target）

#### 10. 环境变量配置 (v0.5 新增)
- 支持 `.env` 文件配置 API Key
- 可配置默认 AI 模型
- 设置自动保存到浏览器本地存储
- 下次打开自动恢复上次设置

#### 11. 故事状态持久化 (v0.5.3 新增)
- **自动保存**：当前编辑的故事（节点、连线、变量）实时保存到本地存储
- **自动恢复**：打开应用时自动加载上次编辑的内容
- 无需手动导出导入，编辑进度永不丢失

#### 12. 树结构定义 (v0.5.2 增强)
- **分支点数量** (1-10)：故事中有多少个"岔路口"
- **每分支选项数** (1-4)：每个岔路口分出几条路
- **层级深度** (1-10)：故事从起点到结局有多长
- **结局数量** (1-6)：故事有多少个不同的结局
- **随机事件** (0-10)：日常/支线剧情数量
- **树结构描述**：自定义结构要求（如"双线并行"、"三结局"等）

**参数组合示例**：
| 分支点 | 选项数 | 层级 | 结局 | 效果 |
|-------|-------|-----|-----|------|
| 2 | 2 | 4 | 2 | 简单分支，双结局 |
| 5 | 3 | 6 | 4 | 复杂网状，四结局 |
| 3 | 2 | 5 | 3 | 标准配置，三结局 |

---

## 🛠️ 技术栈

- **前端框架**：React 19 + TypeScript
- **构建工具**：Vite
- **样式方案**：Tailwind CSS（深色主题）
- **图标库**：Lucide React
- **AI 集成**：@google/genai (Gemini 2.5/3.0), openai (GPT-4o)
- **状态管理**：React Hooks (useState, useEffect, useCallback)
- **数据持久化**：localStorage
- **包管理器**：pnpm（推荐，解决可选依赖问题）

---

## 📝 快速开始

### 安装依赖
```bash
# 推荐使用 pnpm（避免 npm 的可选依赖 bug）
pnpm install
```

### 配置环境变量（可选）
```bash
# 复制示例配置文件
cp .env.example .env

# 编辑 .env 文件，填入你的 API Key
# OPENAI_API_KEY=your_openai_api_key_here
# API_KEY=your_gemini_api_key_here
# DEFAULT_AI_MODEL=gemini-2.5-flash
```

### 启动开发服务器
```bash
pnpm dev
```

### 使用指南

1. **配置 AI 引擎**：
   - 点击左侧 AI 剧情引擎面板的设置图标（⚙️）
   - 选择 AI 模型（Gemini 2.5 Flash/Pro 或 GPT-4o/4o Mini）
   - （可选）输入 API Key，留空则使用环境变量

2. **AI 生成完整故事**：
   - 在左侧面板输入故事梗概
   - 调整生成参数（分支数、选项密度、深度）
   - 点击 "生成剧情" 按钮

3. **AI 生成单个节点内容**：
   - **方式一：快速生成**
     - 点击任意节点框内的 "AI 生成" 按钮
     - AI 会根据相邻节点和整体剧情梗概智能生成内容
   - **方式二：自定义生成** (v0.4 新增)
     - 选中节点后在右侧属性面板找到 "AI 生成内容" 区域
     - 点击 "自定义提示词" 展开输入框
     - 输入具体要求（如"添加悬疑转折"、"让角色更情绪化"、"增加环境描写"）
     - 点击 "AI 生成内容" 按钮
   - 生成内容包括：标题、剧情文本（50-150字）、地点、前置条件、效果等
   - AI 会自动识别节点叙事功能并调整内容风格

4. **手动编辑**：
   - 从左侧面板点击 "添加剧情节点"
   - 连接节点创建剧情分支
   - 在右侧属性面板编辑节点属性

5. **导出与导入** (v0.5 新增)：
   - **导出**：点击顶部工具栏的下载按钮，保存故事为 JSON 文件
   - **导入**：点击上传按钮，选择之前导出的 JSON 文件恢复故事
   - 所有节点、连线、变量、设置都会被保存

6. **运行测试**：
   - 点击顶部 "RUN" 按钮进入模拟模式
   - 查看变量变化和执行日志

---

## 🎨 设计理念

- **可视化叙事**：让复杂的分支不再是程序员的专利，让编剧直观地"看"见故事的走势
- **美学与效率并重**：采用磨砂玻璃质感与动态高亮效果，提升长时间写作的审美体验
- **AI 辅助创作**：降低创作门槛，快速构建复杂叙事结构
- **简洁架构**：v0.2 统一节点类型，通过动态分类实现灵活的表达

---

## 📋 版本历史

### v0.5.4 (当前) - 2025年2月
- ✅ **GPT-5 模型支持**：新增 GPT-5.2、GPT-5.2 Pro、GPT-5.2 Codex、GPT-5 Mini、GPT-5 Nano
- ✅ **默认模型更新**：使用 GPT-5.2 作为默认模型，提供更强的推理能力
- ✅ **API 参数适配**：GPT-5 模型使用 max_completion_tokens 参数

### v0.5.3 - 2025年2月
- ✅ **故事状态自动保存**：当前编辑的故事（节点、连线、变量）自动保存到本地
- ✅ **启动自动恢复**：打开应用时自动加载上次编辑的内容，无需手动导入

### v0.5.2 - 2025年2月
- ✅ **树结构参数增强**：新增结局数量和每分支选项数配置
- ✅ **AI 提示词优化**：更精确地控制生成的树结构

### v0.5.1 - 2025年2月
- ✅ **修复连线显示**：修复 AI 生成后所有节点显示为自由剧情的问题
- ✅ **边格式兼容**：自动兼容 from/to 和 source/target 两种边格式
- ✅ **树结构定义**：新增随机事件数量和自定义树结构描述参数
- ✅ **导入增强**：显示节点数和连线数，自动格式转换
- ✅ **提示词优化**：明确指定边格式，避免 AI 生成错误格式

### v0.5 - 2025年2月
- ✅ **导出/导入功能**：支持导出故事为 JSON 文件，之后可导入恢复
- ✅ **环境变量配置**：支持 .env 文件配置 API Key 和默认模型
- ✅ **设置持久化**：AI 模型、API Key、提示词等自动保存到本地存储
- ✅ **自动恢复设置**：下次打开自动读取上次保存的设置

### v0.4 - 2025年2月
- ✅ **智能叙事分析**：AI 自动识别节点叙事功能（起点、延续、分支、汇聚、结局）
- ✅ **精简内容生成**：50-150字简明内容，避免冗长描述和不必要的新角色
- ✅ **自定义提示词**：右侧属性面板支持添加自定义生成指令
- ✅ **错误边界保护**：防止应用白屏崩溃，友好显示错误信息
- ✅ **浏览器环境优化**：完善 OpenAI API 的浏览器支持配置

### v0.3 - 2025年2月
- ✅ **分支剧情节点**：新增分支剧情分类，用于标记选项后的专属剧情线
- ✅ **单节点 AI 生成**：每个节点内置 AI 生成按钮，根据相邻节点和剧情梗概智能生成内容
- ✅ **API 配置面板**：界面内配置 API Key 和模型选择（无需环境变量）
- ✅ **多模型支持**：Gemini 2.5 Flash/Pro、GPT-4o/4o Mini
- ✅ 移除 UI 切换按钮，后台统一管理 AI 服务
- ✅ 修复 AI 生成后节点内容更新的问题

### v0.2 - 2025年2月
- ✅ 节点系统简化为单一 Scene 类型
- ✅ 动态节点分类（标准/自由/起点/终点）
- ✅ Scene 属性扩展（Has Choice、Group Frame）
- ✅ 连线编辑优化（双向编辑、重连、删除）
- ✅ 使用 pnpm 解决依赖问题

### v0.1 - 2025年1月
- ✅ 完整的可视化节点编辑器
- ✅ 6 种节点类型（START, SCENE, GATE, POOL, FRAME, END）
- ✅ AI 剧情生成集成
- ✅ 多视图系统（Canvas, Tree, Map, DB）
- ✅ 变量系统与实时模拟器
- ✅ 快照管理

---

## 🚀 下一步计划 (v0.5)

- [ ] 实现选项与变量的关联配置
- [ ] Group Frame 的剧情池/剧情块功能
- [ ] 连线标签编辑功能
- [ ] 节点搜索与快速定位
- [ ] 导出为脚本或游戏引擎格式
- [ ] 多语言支持（英文界面）

---

*NovaScribe — 为每一位渴望构建宏大叙事宇宙的创作者而生。*
